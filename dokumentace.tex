\documentclass{report}
\usepackage[utf8]{inputenc}
\usepackage[czech]{babel}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{booktabs}
\usepackage{epstopdf}
\usepackage{caption}
\usepackage{xcolor}
\usepackage{textcomp}
\usepackage{color}
\usepackage{booktabs}

\definecolor{listinggray}{gray}{0.9}
\definecolor{lbcolor}{rgb}{0.9,0.9,0.9}
\lstset{
backgroundcolor=\color{lbcolor},
    tabsize=4,    
%   rulecolor=,
    language=[GNU]C++,
        basicstyle=\scriptsize,
        upquote=true,
        aboveskip={1.5\baselineskip},
        columns=fixed,
        showstringspaces=false,
        extendedchars=false,
        breaklines=true,
        prebreak = \raisebox{0ex}[0ex][0ex]{\ensuremath{\hookleftarrow}},
        frame=L,
        numbers=left,
        showtabs=false,
        showspaces=false,
        showstringspaces=false,
        identifierstyle=\ttfamily,
        keywordstyle=\color[rgb]{0,0,1},
        commentstyle=\color[rgb]{0.026,0.112,0.095},
        stringstyle=\color[rgb]{0.627,0.126,0.941},
        numberstyle=\color[rgb]{0.205, 0.142, 0.73},
%        \lstdefinestyle{C++}{language=C++,style=numbers}’.
}
\lstset{
    backgroundcolor=\color{lbcolor},
    tabsize=4,
  language=C++,
  captionpos=b,
  tabsize=3,
  frame=lines,
  numbers=left,
  numberstyle=\tiny,
  numbersep=5pt,
  breaklines=true,
  showstringspaces=false,
  basicstyle=\footnotesize,
%  identifierstyle=\color{magenta},
  keywordstyle=\color[rgb]{0,0,1},
  commentstyle=\color[rgb]{0.026,0.112,0.095},
  stringstyle=\color{red}
}

\begin{document}

\begin{titlepage}
		\includegraphics[width=267px]{img/fav_logo.pdf}\par\vspace{1cm}
		\centering
		{\scshape\LARGE Západočeská univerzita \par}
		\vspace{0.5cm}
		{\scshape\Large Defragmentace pseudoFAT tabulky\par}
		\vspace{2cm}
		{\Large\bfseries Semestrální práce - UPS \par}
		\vspace{0.5cm}
		{\Large\itshape Petr Štechmüller\par}
		\vfill
		{\large \today\par}
\end{titlepage}

\tableofcontents

\chapter*{Zadání}
\addcontentsline{toc}{chapter}{Zadání}
Vytvořte jednoduchý souborový systém, který bude organizován pomocí pseudoFAT tabulky. Nad souborovým systémem budete provádět následující operace:
\begin{itemize}
\item Vytvoření nového souboru
\item Smazání souboru
\item Vypsat čísla clusterů obsahující data zadaného souboru
\item Vypsat obsah souboru
\item Vytvoření prázdné složky
\item Smazání prázdné sožky
\item Vypsat stromovou strukturu celého souborového systému
\item Provést úplnou defragmentaci souborového systému
\end{itemize}

\chapter*{Implementace}
\addcontentsline{toc}{chapter}{Implementace}
Souborový systém se snaží simulovat prostředí v linuxu. Jako znak oddělující jednotlivé soubory a složky od sebe je použito "/". Kořenový adresář se jmenuje "/". Při implementaci byla použity následující struktury pro boot record\ref{lst:boot_record} a root directory\ref{lst:root_directory}:
\lstinputlisting[language=C++, caption={Struktura pro boot record}, label={lst:boot_record}]{code/boot_record.h}
\lstinputlisting[language=C++, caption={Struktura pro root directory}, label={lst:root_directory}]{code/root_directory.h}
Celý souborový systém je implementován v jazyce C++ a je reprezentován třídou Fat. Třída Fat obsahuje následující veřejné metody\ref{lst:fat_public_methods}:
\lstinputlisting[language=C++, caption={Veřejné metody třídy Fat}, label={lst:fat_public_methods}]{code/fat_public_methods.h}

\section*{Vytvoření nového souboru}
\addcontentsline{toc}{section}{Vytvoření nového souboru}
Při vytváření nového souboru se nejdříve zkontroluje, jestli existuje kopírovaný soubor. Dále se najde rodičovský adresář\ref{lst:insert_file_init} nového souboru.
\lstinputlisting[language=C++, caption={Inicializace proměnných pro vložení nového souboru}, label={lst:insert_file_init}]{code/insert_file_init.h}
Dále se zkontroluje, zda-li není rodičovská složka plná a neobsahuje soubor stejného názvu. Když projdou všechny validace, tak se najdou volné clustery pro soubor a uloží se obsah. Nakonec se uloží záznam v rodičovské složce o novém souboru. Příklad použítí\ref{lst:insert_file_example}
\begin{lstlisting}[caption=Vytvoření nového souboru,label=lst:insert_file_example, language={}]
./zos_semestralka_fat test.fat -a ./f.txt /f.txt
 \end{lstlisting}

\section*{Smazání souboru}
\addcontentsline{toc}{section}{Smazání souboru}
Před samotným smazáním souboru se načte obsah rodičovské složky a odstraní se záznam o souboru. Dále se vymažou záznamy ve fat tabulce. Obsah v clustrech zůstane zachován.
\begin{lstlisting}[caption=Smazání souboru,label=lst:delete_file_example, language={}]
./zos_semestralka_fat test.fat -f /f.txt
 \end{lstlisting}

\section*{Výpis clusterů obsahující data souboru}
\addcontentsline{toc}{section}{Výpis clusterů obsahující data souboru}
Příklad výpisu clusterů\ref{lst:clusters}
\begin{lstlisting}[caption=Výpis clusterů obsahující data souboru,label=lst:clusters, language={}]
./zos_semestralka_fat test.fat -c /a.txt

/a.txt: 1, 2, 3, 4,
 \end{lstlisting}
 

\section*{Výpis obsahu souboru}
\addcontentsline{toc}{section}{Výpis obsahu souboru}
Příklad výpisu clusterů\ref{lst:clusters_content}
\begin{lstlisting}[caption=Výpis obsahu zadaného souboru,label=lst:clusters_content, language={}]
./zos_semestralka_fat test.fat -l /a.txt

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris commodo, ipsum ac commodo imperdiet, tortor ante euismod nisi, quis aliquet nibh quam eu justo. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed in feugiat lacus. Morbi eget ante varius, tincidunt neque consequat, tincidunt tellus. Cras hendrerit mi vitae convallis mollis. Donec eu nisi vehicula, pellentesque sem at, interdum sapien. Sed ullamcorper tristique sapien, in rhoncus metus hendrerit non. Nam elementum neque enim, vitae laoreet ligula blandit nec.
 \end{lstlisting}
 

\section*{Vytvoření prázdné složky}
\addcontentsline{toc}{section}{Vytvoření prázdné složky}
Vytvoření složky\ref{lst:create_folder_example} probíhá velmi podobně jako vytvoření nového souboru.
\begin{lstlisting}[caption=Smazání souboru,label=lst:create_folder_example, language={}]
./zos_semestralka_fat test.fat -m bin /
 \end{lstlisting}

\section*{Smazání prázdné složky}
\addcontentsline{toc}{section}{Smazání prázdné složky}
Smazání složky\ref{lst:delete_folder_example} probíhá stejným způsobem, jako smazání souboru s tím rozdílem, že před smazáním se zkontroluje, zda-li je složka prázdná. Pokud složka prázdná není, tak se nesmaže.
\begin{lstlisting}[caption=Smazání souboru,label=lst:delete_folder_example, language={}]
./zos_semestralka_fat test.fat -r /bin
 \end{lstlisting}


\section*{Výpis stromové struktury}
\addcontentsline{toc}{section}{Výpis stromové struktury}
Pro výpis stromové struktury\ref{lst:tree_structure} se používá rekurze. Když se narazí na složku, tak se zavolá rekurzivně metoda pro výpis stromové struktury.
\lstinputlisting[language={}, caption={Výpis stromové struktury}, label={lst:tree_structure}]{code/tree_structure.txt}

\section*{Defragmentace}
\addcontentsline{toc}{section}{Defragmentace}
Úplná defragmentace spočívá v tom, že se nejenom odstraní mezery mezi soubory, ale také se linearizují obsahy souborů tak, aby clustery jednoho souboru byly pohromadě.
Při defragmentaci se přesouvají pouze clustery souborů. Pokud se narazí na cluster, který obsahuje složku, tak je přeskočen. Celý proces defragmentace běží pouze v jednom vlákně, protože paralelizace neměla smysl. Pouze načtení kompletní stromové struktury před defragmentací se provádí paralelně. Pro dosažení paralelismu se používá Threadpool. Defragmentaci je nutné spouštět pomocí přiloženého skriptu \textbf{defragmenter.sh}\ref{lst:defrag_example}.
\begin{lstlisting}[caption=Spuštění defragmentace,label=lst:defrag_example, language={}]
./defragmenter.sh test.fat
 \end{lstlisting}

\chapter*{Závěr}
\addcontentsline{toc}{chapter}{Závěr}
Vytvořit vlastní souborový systém byla velká výzva. Základní práce jako vytváření a mazání souborů a složek byla jednoduchá. Defragmentace už byla horší. Vzhledem k tomu, že paralelně se pouze načítá stromová struktura a zbytek se provádí v jednom vlákně, tak nejsou přiloženy žádné srovnávací časy.

\end{document}